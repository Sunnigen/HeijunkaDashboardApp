@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Timeline";
}
@using HeijunkaTest.Models
@using Syncfusion.EJ2
@using Syncfusion.EJ2.Schedule
<div class="control-section">
    <div class="content-wrapper">

        <div class="event-container">
            <div class="title-container">
                <h2 class="title-text">Info/Events</h2>
            </div>
            <label id="queue-count-label">There are @ViewBag.Owners.Count Queues at the moment</label>
        </div>
        
        <div class="schedule-container">
            <div class="title-container">
                <h2 class="title-text">Digital Heijunka</h2>
            </div>           
            
            <!--
           (Html.EJS().Schedule("schedule")
             .Width("100%")
             .Height("650px")
             .CssClass("schedule-drag-drop")
             .Views(view => { 
                 view.Option(View.TimelineDay).Add(); 
                 view.Option(View.TimelineMonth).Add(); 
             })
             .CurrentView(View.TimelineDay)
             .SelectedDate(new DateTime(DateTime.Today.Year, 7, 2))             
             .Group(group => group.EnableCompactView(false)
             .Resources(ViewBag.Resources)).Resources(res =>
                    {
                        res.DataSource(ViewBag.Departments).Field("DepartmentID").Title("Department").Name("Departments").TextField("text").IdField("id").ColorField("color").Add();
                        res.DataSource(ViewBag.Consultants).Field("ConsultantID").Title("Consultant").Name("Consultants").TextField("text").IdField("id").ColorField("color").GroupIDField("groupId").AllowMultiple(false).Add();
                    })
             .ResourceHeaderTemplate("#resource-template")
             .ActionBegin("OnActionBegin")
             .Drag("OnItemDrag")
             .EventSettings(e => e.Fields(f => f.Subject(sub => sub.Name("Name").Title("Patient Name"))
             .StartTime(start => start.Name("StartTime").Title("From"))
             .EndTime(end => end.Name("EndTime").Title("To"))
             .Description(des => des.Name("Description").Title("Reason")))
             .DataSource(ViewBag.datasource))
             .Render()
           )  -->
                        
           <!--field="OwnerId" title="Owners" name="Owners" textField="Text" idField="Id" colorField="Color" -->
            @(Html.EJS().Schedule("schedule")
             .Width("100%")
             .Height("550px")
             .Group(group => group.Resources(ViewBag.Resources))
             .Resources(res => {res.DataSource(ViewBag.Owners)
                 .Field("OwnerId")
                 .Title("Owners")
                 .Name("Owners")
                 .TextField("Text")
                 .IdField("Id")
                 .ColorField("Color")
                 .Add();
             })
             .Views(view => view
                .Option(View.TimelineDay)
                .AllowVirtualScrolling(true)
                .Add()
             )
             .TimeScale(ts => ts
                .Enable(true)
                .Interval(60)
                .SlotCount(6)
             )
             .SelectedDate(new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day))
             .HeaderRows(headerRow => headerRow.Option(HeaderRowType.Hour).Add())
             .EventSettings(new ScheduleEventSettings{DataSource = ViewBag.Appointments})
             .ActionBegin("onActionBegin")
             .Drag("OnItemDrag")
             .EventRendered("onEventRendered") 
             .PopupOpen("onPopupOpen")
             .EditorTemplate("#EventEditorTemplate") 
             .ShowQuickInfo(false)
             .Render()
            )


            <ejs-button id="addQueueButton" onclick="addQueue()" content="Add Queue"></ejs-button>
            <ejs-button id="removeQueueButton" onclick="removeQueue()" content="Remove Queue"></ejs-button>
            <ejs-button id="getDataButton" onclick="printtoConsole()" content="Print Data"></ejs-button>
            <ejs-button id="addAppointment" onclick="addAppointment()" content="Schedule Process"></ejs-button>
            <ejs-button id="addStagingButton" onclick="addStaging()" content="Stage Process"></ejs-button>
        </div>
        <!-- Staging Area for Parts to Process -->
        <div class="treeview-container">
            <div class="title-container">
                <h2 class="title-text">Staging Area</h2>
            </div>
            <!-- Actual TreeView Widget-->
            @(Html.EJS().TreeView("tree")
                .Fields(Fields => Fields.DataSource(ViewBag.DataSource)
                    .Id("Id")
                    .Text("Name")
                    .Text("OrderNumber")
                )
                .AllowEditing(true)
                .AllowDragAndDrop(true)
                .NodeDragStop("OnTreeDragStop")
                .NodeDragging("OnItemDrag")
                .NodeTemplate("#treeTemplate")
                .DragArea(".content-wrapper")
                .CssClass("treeview-external-drag")
                .Render()
            )
        </div>
    </div>
</div>

<style>
    .content-wrapper{
        display:-ms-flexbox;
        display:flex;
    }
    .e-device-hover {
        background-color: #e0e0e0 !important;
    }

    .schedule-container {
        padding-right: 10px;
        width: 100%;
    }
        
    .e-location-container{
        float: right;
    }
    .title-container {
        padding-bottom: 10px;
    }

    .title-text {
        font-size: 18px;
        margin: 0px;
        font-weight: bold;
        text-align: center;
    }

    .custom-event-editor .e-textlabel {
        padding-right: 15px;
        text-align: right;
    }

    .custom-event-editor td {
        padding: 7px;
        padding-right: 16px;
    }

    .treeview-external-drag #waiting {
        height: 100%;
        padding: 0;
    }

    .treeview-external-drag #waitdetails {
        width: 95%;
        float: left;
        height: 100%;
        padding: 0;
    }

    .treeview-external-drag #waitlist {
        width: 100%;
        height: 50%;
        font-weight: bold;
        font-family: "Segoe UI";
        font-size: 12px;
        padding: 5px 0 0 10px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .treeview-external-drag #ordernumber {
        height: 50%;
        font-family: "Segoe UI";
        font-size: 10px;
        opacity: 0.6;
        padding-left: 10px;
        padding-top: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .treeview-external-drag .e-list-text,
    .e-bigger .treeview-external-drag .e-list-text {
        border: 0.5px solid #E1E7EC;
        height: 50px;
        line-height: 15px;
        padding: 0 5px;
        width: 220px;
    }

    .treeview-external-drag .e-list-parent,
    .e-bigger .treeview-external-drag .e-list-parent {
        height: 100%;
        padding: 0 2px;
    }

    .treeview-external-drag .e-list-item,
    .e-bigger .treeview-external-drag .e-list-item {
        height: 100%;
        padding: 0 0 5px 0;
    }

    .treeview-external-drag .e-fullrow,
    .e-bigger .treeview-external-drag .e-fullrow {
        height: 55px;
    }

    .treeview-external-drag .e-list-item.e-hover > .e-fullrow,
    .treeview-external-drag .e-list-item.e-active > .e-fullrow,
    .treeview-external-drag .e-list-item.e-active.e-hover > .e-fullrow,
    .e-bigger .treeview-external-drag .e-list-item.e-hover > .e-fullrow,
    .e-bigger .treeview-external-drag .e-list-item.e-active > .e-fullrow,
    .e-bigger .treeview-external-drag .e-list-item.e-active.e-hover > .e-fullrow {
        background-color: transparent;
        border-color: transparent;
        box-shadow: none !important;
    }

    .treeview-external-drag .e-text-content,
    .e-bigger .treeview-external-drag .e-text-content {
        padding: 0;
    }

    .e-drag-item.e-treeview.treeview-external-drag,
    .e-bigger .e-drag-item.e-treeview.treeview-external-drag {
        padding: 0 !important;
    }

    .e-schedule.schedule-drag-drop .e-timeline-view .e-resource-left-td,
    .e-schedule.schedule-drag-drop .e-timeline-month-view .e-resource-left-td {
        width: 160px;
    }

    .e-schedule.schedule-drag-drop .e-resource-cells.e-parent-node .specialist-category {
        padding-left: 30px
    }

    .e-schedule.e-rtl.schedule-drag-drop .e-resource-cells.e-parent-node .specialist-category {
        padding-right: 30px
    }

    .e-schedule.schedule-drag-drop .e-resource-cells.e-child-node .specialist-category,
    .e-schedule.schedule-drag-drop .e-resource-cells.e-child-node .specialist-name {
        padding: 5px
    }

    .tailwind .e-schedule.schedule-drag-drop .e-resource-cells.e-child-node .specialist-category,
    .tailwind .e-schedule.schedule-drag-drop .e-resource-cells.e-child-node .specialist-name,
    .tailwind-dark .e-schedule.schedule-drag-drop .e-resource-cells.e-child-node .specialist-category,
    .tailwind-dark .e-schedule.schedule-drag-drop .e-resource-cells.e-child-node .specialist-name {
        padding: unset !important;
    }

    .e-schedule.schedule-drag-drop .e-resource-cells.e-parent-node .specialist-name {
        padding: 0 10px
    }

    .e-schedule.schedule-drag-drop .e-resource-cells.e-parent-node .template-wrap {
        padding: 3px 0px;
    }

    .e-schedule.schedule-drag-drop .e-resource-cells.e-child-node .specialist-category .specialist-image {
        width: 45px;
        height: 40px;
        float: left;
        border-radius: 50%;
        margin-right: 10px;
    }

    .e-schedule.schedule-drag-drop .specialist-name {
        font-size: 13px;
    }

    .e-schedule.schedule-drag-drop .specialist-designation {
        font-size: 10px;
    }

    .e-schedule-dialog .e-all-day-time-zone-row,
    .e-schedule-dialog .e-location-container,
    .e-bigger .e-schedule-dialog .e-all-day-time-zone-row,
    .e-bigger .e-schedule-dialog .e-location-container {
        display: none;
    }

    .e-schedule-dialog .e-subject-container,
    .e-bigger .e-schedule-dialog .e-subject-container {
        padding-right: 0;
        width: 100%;
    }

    .e-schedule-dialog.e-rtl .e-subject-container,
    .e-bigger .e-schedule-dialog.e-rtl .e-subject-container {
        padding-left: 0;
    }

    @@media (max-width: 550px) {


        .treeview-external-drag.e-treeview,
        .e-bigger .treeview-external-drag.e-treeview {
            width: 225px;
        }

            .e-bigger .treeview-external-drag.e-treeview.e-drag-item {
                position: relative !important;
            }
    }
</style>

<!-- Template to render tree node -->
<script id="treeTemplate" type="text/x-template">
    <div id="waiting">
        <div id="waitdetails">
            <div id="waitlist">${Name}</div>
            <div id="ordernumber">
                <label>Order Number:&ensp;</label>
                <label> ${OrderNumber}</label>
            </div>
        </div>
    </div>
</script>


<script id="EventEditorTemplate" type="text/x-template">
    <table class="custom-event-editor" width="100%" cellpadding="5">
        <tbody>
            <tr>
                <td class="e-textlabel">Part</td>
                <td colspan="4">
                    <input id="Subject" class="e-field e-input" type="text" name="Subject" style="width: 100%"></input>
                </td>
            </tr>
            <tr>
                <td class="e-textlabel">Order Number</td>
                <td colspan="4">
                    <input id="OrderNumber" class="e-field e-input" type="number" name="OrderNumber" style="width: 100%"></input>
                </td>
            </tr>
            <tr>
                <td class="e-textlabel">From</td>
                <td colspan="4">
                    <input id="StartTime" class="e-field" type="text" name="StartTime" />
                </td>
            </tr>
            <tr>
                <td class="e-textlabel">To</td>
                <td colspan="4">
                    <input id="EndTime" class="e-field" type="text" name="EndTime" />
                </td>
            </tr>


            <tr>
                <td class="e-textlabel">Queue</td>
                <td colspan="4">
                    <input id="OwnerId" class="e-field" name="OwnerId" />
                </td>
            </tr>


        </tbody>
    </table>
</script>

<script type="text/javascript">

    var isTreeItemDropped = false;
    var draggedItemId = '';

    function OnItemDrag(event) {
        var scheduleObj = document.querySelector(".e-schedule").ej2_instances[0];
        if (scheduleObj.isAdaptive) {
            var classElement = scheduleObj.element.querySelector('.e-device-hover');
            if (classElement) {
                classElement.classList.remove('e-device-hover');
            }
            if (event.event.target.classList.contains('e-work-cells')) {
                ej.base.addClass([event.event.target], 'e-device-hover');
            }
        }
        //document.body.style.position = 'fixed';   // this might cause problems later, right now it creates an empty column on right of entire page
        if (document.body.style.cursor === 'not-allowed') {
            document.body.style.cursor = '';
        }
        if (event.name == 'nodeDragging') {
            var dragElementIcon = document.querySelectorAll('.e-drag-item .e-icon-expandable');
            for (var i = 0; i < dragElementIcon.length; i++) {
                dragElementIcon[i].style.display = 'none';
            }
        }
    }

    function onActionBegin(event) {
        if (event.requestType === 'eventCreate' && isTreeItemDropped) {
            var treeObj = document.querySelector(".e-treeview.treeview-external-drag").ej2_instances[0];
            var treeViewdata = treeObj.fields.dataSource;
            var filteredPeople = treeViewdata.filter(function (item) { return item.Id !== parseInt(draggedItemId, 10); });
            treeObj.fields.dataSource = filteredPeople;
            var elements = document.querySelectorAll('.e-drag-item.treeview-external-drag');
            for (var i = 0; i < elements.length; i++) {
                remove(elements[i]);
            }
        }
    }

    function OnTreeDragStop(event) {
        var treeElement = ej.base.closest(event.target, '.e-treeview');
        var scheduleObj = document.querySelector(".e-schedule").ej2_instances[0];
        var classElement = scheduleObj.element.querySelector('.e-device-hover');
        if (classElement) {
            classElement.classList.remove('e-device-hover');
        }
        if (!treeElement) {
            event.cancel = true;
            var scheduleElement = ej.base.closest(event.target, '.e-content-wrap');
            if (scheduleElement) {
                var treeviewData = this.fields.dataSource;
                if (event.target.classList.contains('e-work-cells')) {
                    var filteredData =
                        treeviewData.filter(function (item) { return item.Id === parseInt(event.draggedNodeData.id, 10); });
                    var cellData = scheduleObj.getCellDetails(event.target);
                    var resourceDetails = scheduleObj.getResourcesByIndex(cellData.groupIndex);
                    var eventData = {
                        Name: filteredData[0].Name,
                        OrderNumber: filteredData[0].OrderNumber,
                        StartTime: cellData.startTime,
                        EndTime: cellData.endTime,
                        OwnerId: resourceDetails.resourceData.Id,
                        Id:resourceDetails.resourceData.Id
                    };
                    //scheduleObj.openEditor(eventData, 'Add');
                    isTreeItemDropped = true;
                    draggedItemId = event.draggedNodeData.id;
                    scheduleProcess(eventData);
                }
            }
        }
    }

    function scheduleProcess(args) {
        var scheduleObj = document.getElementById('schedule').ej2_instances[0];
        var scheduleEventsData = scheduleObj.eventsData;
        var newProcess = {
            Id: scheduleEventsData.length + 1, 
            OwnerId: args.OwnerId, 
            Subject: args.Name, 
            OrderNumber: args.OrderNumber,
            StartTime: args.StartTime, 
            EndTime: args.EndTime
        }
        console.log(`scheduleProcess\n\tId: ${newProcess.Id}, OwnerId: ${newProcess.OwnerId}, Subject: ${newProcess.Subject}, StartTime: ${newProcess.StartTime}, EndTime: ${newProcess.EndTime}`);
        scheduleObj.addEvent(newProcess);
        //var newProcess = {Id: scheduleEventsData.length + 1, OwnerId: scheduleResources.length, Subject: "Drilling (120) fasteners", StartTime: startDate, EndTime: endDate}
    }

    function onEventRendered(args) {
    }

    function onPopupOpen(args) {
        if (args.type === 'Editor') {
            var processElement = args.element.querySelector('#Subject');
            //processElement.innerHTML = args.data.Subject;

            if (!processElement.classList.contains('e-dropdownlist'))
            {
                var dropDownListObject = new ej.dropdowns.DropDownList({
                    placeholder: "Schedule a part:",
                    dataSource: ['Aileron', 'Wing Skin', 'Hinge Flap', 'Rib Bracket', 'Winglet'],
                    value: args.data.Subject
                })
                dropDownListObject.appendTo(processElement);
                processElement.setAttribute('name', 'Subject');
            }
            var orderElement = args.element.querySelector('#OrderNumber');
            console.log(`args.data.OrderNumber: ${args.data.OrderNumber}`);
            orderElement.value = args.data.OrderNumber;

            var startElement = args.element.querySelector('#StartTime');
            if (!startElement.classList.contains('e-datetimepicker')) {
                new ej.calendars.DateTimePicker({ value: new Date(startElement.value) || new Date(), min: Date(startElement.value) }, startElement);
            }
            var endElement = args.element.querySelector('#EndTime');
            if (!endElement.classList.contains('e-datetimepicker')) {
                new ej.calendars.DateTimePicker({ value: new Date(endElement.value) || new Date(), min: Date(endElement.value)  }, endElement);
            }

            var queueElement = args.element.querySelector('#OwnerId');
            var scheduleObj = document.getElementById('schedule').ej2_instances[0];
            var scheduleObjResource = scheduleObj.resources[0].dataSource;
            console.log(`queueElement.value: ${queueElement.value}`);
            //var cellData = scheduleObj.getCellDetails(event.target);
            //if (cellData) {
            //    var groupIndex = cellData.groupIndex + 1
            //} else {
            //    var groupIndex = queueElement.value;
            //}

            if (!queueElement.classList.contains('e-dropdownlist')){
                var dropDownListObject = new ej.dropdowns.DropDownList({
                    placeholder: "Select a queue:",
                    dataSource: scheduleObjResource,
                    fields: {text: 'Text', value: 'Id'},
                    value: args.data.OwnerId
                })
                dropDownListObject.appendTo(queueElement);
                queueElement.setAttribute('name', 'OwnerId');
            }

        }
    }

    

    function removeQueue() {
        var scheduleObj = document.getElementById('schedule').ej2_instances[0];
        var scheduleResources = scheduleObj.resources[0].dataSource;

        if (scheduleResources.length > 0) {
            scheduleObj.removeResource(scheduleResources.length,'Owners');
            scheduleResources.pop();
            var label = document.getElementById('queue-count-label');
            label.innerHTML = `There are ${scheduleResources.length} Queues at the moment!`;
        }
    }

    function addQueue() {
        var scheduleObj = document.getElementById('schedule').ej2_instances[0];
        var scheduleResources = scheduleObj.resources[0].dataSource;
        //ownerData.Add(new OwnerModel { Id = 3, Text = "Cutting Edge 3", Color  = "#7499e1" });
        var collection = {Id: scheduleResources.length + 1, Text: `Cutting Edge ${scheduleResources.length + 1}`, Color: "#7499e1"}
        
        scheduleObj.addResource(collection,'Owners', scheduleResources.length);
        scheduleResources.push(collection);

        var label = document.getElementById('queue-count-label');
        label.innerHTML = `There are ${scheduleResources.length} Queues at the moment!`;

    }

    function addAppointment() {
        var scheduleObj = document.getElementById('schedule').ej2_instances[0];
        var scheduleResources = scheduleObj.resources[0].dataSource;  // current queues in place



        var scheduleEventsData = scheduleObj.eventsData;   // current appointments in place


        var startDate = new Date();

        var endDate = new Date();
        endDate.setHours(endDate.getHours() + 3);


        var newProcess = {Id: scheduleEventsData.length + 1, OwnerId: scheduleResources.length, Subject: "Drilling (120) fasteners", StartTime: startDate, EndTime: endDate}
        //scheduleObj.openEditor(newProcess, 'Add', true);

        scheduleObj.addEvent(newProcess);
    

        //scheduleEventsData.push(newProcess);
        //scheduleObj.refreshLayout();
    }

    function addStaging() {
        var treeView = document.getElementById('tree').ej2_instances[0];

        var content = {
            Id: 4,
            Name: "Shear Web"
        }

        //treeView.addNodes(content);
        treeView.fields.dataSource.push(content);
        treeView.refresh();
        console.log(treeView.fields.dataSource);


    }

    function printtoConsole() {
        var scheduleObj = document.getElementById('schedule').ej2_instances[0];
        var treeView = document.getElementById('tree').ej2_instances[0];
        var scheduleResources = scheduleObj.resources[0].dataSource;
        var scheduleEventsData = scheduleObj.eventsData;
        console.log(scheduleObj);
        console.log(treeView);
        console.log(scheduleEventsData);
        console.log(scheduleResources);
        //var complexObject = {
        //    Id: 1,
        //    Text: 'Hello World!',
        //    Color: 'Red'
        //};

        //$.ajax({
        //    type: "POST",
        //    url: "Heijunka/TestFunction1",
        //    data: complexObject,
        //    contentType: "application/json; charset=utf-8",
        //    dataType: "json",
        //    success: function (arg) {
        //      alert(arg);
        //      console.log(arg);
        //    },
        //    error: function (xhr) {
        //        alert("ERROR!!");
        //        alert(xhr);
        //    }
        //});
    };
</script>